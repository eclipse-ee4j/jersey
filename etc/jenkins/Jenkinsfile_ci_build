pipeline {
    agent none

    options {
          timeout(time: 30, activity: true, unit: 'HOURS')
    }

    stages {
        stage('Jersey build') {
            parallel {
                stage('JDK 8 ') {
                    agent {
                        kubernetes {
                            label 'jdk8-agent-pod'
                            yaml """
apiVersion: v1
kind: Pod
spec:
  volumes:
  - name: tools
    persistentVolumeClaim:
      claimName: tools-claim-jiro-eclipselink
  - name: volume-known-hosts
    configMap:
      name: known-hosts      
  - name: settings-xml
    secret:
      secretName: m2-secret-dir
      items:
      - key: settings.xml
        path: settings.xml
  - name: toolchains-xml
    configMap:
      name: m2-dir
      items:
      - key: toolchains.xml
        path: toolchains.xml
  - name: settings-security-xml
    secret:
      secretName: m2-secret-dir
      items:
      - key: settings-security.xml
        path: settings-security.xml
  - name: m2-repo
    emptyDir: {}
    
  containers:
  - name: jnlp
    resources:
      limits:
        memory: "4096Mi"
        cpu: "2000m"
      requests:
        memory: "4096Mi"
        cpu: "1000m"
    image: tkraus/el-build:2.0.2
    volumeMounts:
    - name: volume-known-hosts
      mountPath: /home/jenkins/.ssh    
    - name: tools
      mountPath: /opt/tools
    - name: settings-xml
      mountPath: /home/jenkins/.m2/settings.xml
      subPath: settings.xml
      readOnly: true
    - name: toolchains-xml
      mountPath: /home/jenkins/.m2/toolchains.xml
      subPath: toolchains.xml
      readOnly: true
    - name: settings-security-xml
      mountPath: /home/jenkins/.m2/settings-security.xml
      subPath: settings-security.xml
      readOnly: true
    - name: m2-repo
      mountPath: /home/jenkins/.m2/repository
    tty: true
    command:
    - cat
"""
                        }
                    }
                    tools {
                        jdk 'oracle-jdk8-latest'
                        maven 'apache-maven-latest'
                    }
                    steps {
                        sh '''
                                bash ${WORKSPACE}/etc/jenkins/jenkins_build.sh
                            '''
                    }
                }
                stage('JDK 11 ') {
                    agent {
                        kubernetes {
                            label 'jdk11-agent-pod'
                            yaml """
apiVersion: v1
kind: Pod
spec:
  volumes:
  - name: tools
    persistentVolumeClaim:
      claimName: tools-claim-jiro-eclipselink
  - name: volume-known-hosts
    configMap:
      name: known-hosts      
  - name: settings-xml
    secret:
      secretName: m2-secret-dir
      items:
      - key: settings.xml
        path: settings.xml
  - name: toolchains-xml
    configMap:
      name: m2-dir
      items:
      - key: toolchains.xml
        path: toolchains.xml
  - name: settings-security-xml
    secret:
      secretName: m2-secret-dir
      items:
      - key: settings-security.xml
        path: settings-security.xml
  - name: m2-repo
    emptyDir: {}
    
  containers:
  - name: jnlp
    resources:
      limits:
        memory: "4096Mi"
        cpu: "2000m"
      requests:
        memory: "4096Mi"
        cpu: "1000m"
    image: tkraus/el-build:2.0.2
    volumeMounts:
    - name: volume-known-hosts
      mountPath: /home/jenkins/.ssh
    - name: tools
      mountPath: /opt/tools
    - name: settings-xml
      mountPath: /home/jenkins/.m2/settings.xml
      subPath: settings.xml
      readOnly: true
    - name: toolchains-xml
      mountPath: /home/jenkins/.m2/toolchains.xml
      subPath: toolchains.xml
      readOnly: true
    - name: settings-security-xml
      mountPath: /home/jenkins/.m2/settings-security.xml
      subPath: settings-security.xml
      readOnly: true
    - name: m2-repo
      mountPath: /home/jenkins/.m2/repository
    tty: true
    command:
    - cat
"""
                        }
                    }
                    tools {
                        jdk 'openjdk-jdk11-latest'
                        maven 'apache-maven-latest'
                    }
                    steps {
                        sh '''
                                bash ${WORKSPACE}/etc/jenkins/jenkins_build.sh
                            '''
                    }
                }
                stage('JDK 19 ') {
                    agent {
                        kubernetes {
                            label 'jdk19-agent-pod'
                            yaml """
apiVersion: v1
kind: Pod
spec:
  volumes:
  - name: tools
    persistentVolumeClaim:
      claimName: tools-claim-jiro-eclipselink
  - name: volume-known-hosts
    configMap:
      name: known-hosts      
  - name: settings-xml
    secret:
      secretName: m2-secret-dir
      items:
      - key: settings.xml
        path: settings.xml
  - name: toolchains-xml
    configMap:
      name: m2-dir
      items:
      - key: toolchains.xml
        path: toolchains.xml
  - name: settings-security-xml
    secret:
      secretName: m2-secret-dir
      items:
      - key: settings-security.xml
        path: settings-security.xml
  - name: m2-repo
    emptyDir: {}
    
  containers:
  - name: jnlp
    resources:
      limits:
        memory: "1Gi"
        cpu: "0.5"
      requests:
        memory: "0.8Gi"
        cpu: "0.3"
    volumeMounts:
    - name: volume-known-hosts
      mountPath: /home/jenkins/.ssh    
  - name: el-build
    resources:
      limits:
        memory: "7Gi"
        cpu: "1.5"
      requests:
        memory: "6Gi"
        cpu: "1"
    image: tkraus/el-build:2.0.2
    volumeMounts:
    - name: tools
      mountPath: /opt/tools
    - name: settings-xml
      mountPath: /home/jenkins/.m2/settings.xml
      subPath: settings.xml
      readOnly: true
    - name: toolchains-xml
      mountPath: /home/jenkins/.m2/toolchains.xml
      subPath: toolchains.xml
      readOnly: true
    - name: settings-security-xml
      mountPath: /home/jenkins/.m2/settings-security.xml
      subPath: settings-security.xml
      readOnly: true
    - name: m2-repo
      mountPath: /home/jenkins/.m2/repository
    tty: true
    command:
    - cat
"""
                        }
                    }
                    tools {
                        jdk 'openjdk-jdk19-latest'
                        maven 'apache-maven-latest'
                    }
                    steps {
                        sh '''
                                bash ${WORKSPACE}/etc/jenkins/jenkins_build.sh
                            '''
                    }
                }
            }
        }
    }
}